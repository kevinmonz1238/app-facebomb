<ion-header [translucent]="true">
  <ion-toolbar style="--background: #1b100e; border-bottom: 2px solid #7b3b1d">
    <ion-buttons slot="start">
      <ion-menu-button
        menu="first"
        style="color: #ffcc5c; font-size: clamp(0.8rem, 4vw, 1.2rem)"
      ></ion-menu-button>
    </ion-buttons>
    <ion-title
      style="
        color: #ffcc5c;
        font-family: 'Press Start 2P', monospace;
        font-size: clamp(0.7rem, 3.5vw, 0.9rem);
        text-shadow: 1px 1px 0 #4a260c;
        text-align: center;
        padding: 0.5rem;
      "
    >
      TIENDA
    </ion-title>

    <!-- Bot√≥n del carrito con contador -->
    <ion-buttons slot="end">
      <ion-button
        routerLink="/carrito"
        style="
          --color: #ffcc5c;
          --background: transparent;
          --padding-start: 0.5rem;
          --padding-end: 0.5rem;
          position: relative;
          margin-right: 0.5rem;
        "
      >
        <ion-icon
          name="cart"
          style="font-size: clamp(1rem, 4vw, 1.4rem);"
        ></ion-icon>

        <!-- Badge/Contador de items -->
        <div
          *ngIf="itemsCarrito > 0"
          style="
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #ff4800 0%, #ff0000 100%);
            color: #ffffff;
            border-radius: 50%;
            width: clamp(18px, 4.5vw, 22px);
            height: clamp(18px, 4.5vw, 22px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.4rem, 1.8vw, 0.5rem);
            text-shadow: 1px 1px 0 #7b1e00;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
            animation: pulse 2s infinite;
          "
        >
          {{ itemsCarrito > 99 ? '99+' : itemsCarrito }}
        </div>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" style="--background: #241a17">
  <!-- Efecto CRT -->
  <div
    style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1) 0px,
        rgba(0, 0, 0, 0.1) 1px,
        transparent 2px
      );
      z-index: 9999;
      opacity: 0.1;
    "
  ></div>

  <div class="container" style="padding: clamp(0.8rem, 3vw, 1rem)">

    <!-- Mensaje de √©xito cuando se agrega al carrito -->
    <div
      *ngIf="mensajeExito"
      style="
        background: #1b5e20;
        border: 2px solid #00ff88;
        border-radius: 8px;
        padding: clamp(0.8rem, 3vw, 1rem);
        margin-bottom: clamp(1rem, 4vw, 1.5rem);
        text-align: center;
      "
    >
      <p
        style="
          color: #aaffcc;
          font-family: 'Press Start 2P', monospace;
          font-size: clamp(0.5rem, 2.5vw, 0.6rem);
          margin: 0;
          line-height: 1.4;
        "
      >
        ‚úÖ {{ mensajeExito }}
      </p>
    </div>

    <!-- Mensaje de error -->
    <div
      *ngIf="mensajeError"
      style="
        background: #5c1a1a;
        border: 2px solid #ff5555;
        border-radius: 8px;
        padding: clamp(0.8rem, 3vw, 1rem);
        margin-bottom: clamp(1rem, 4vw, 1.5rem);
        text-align: center;
      "
    >
      <p
        style="
          color: #ffcccc;
          font-family: 'Press Start 2P', monospace;
          font-size: clamp(0.5rem, 2.5vw, 0.6rem);
          margin: 0;
          line-height: 1.4;
        "
      >
        ‚ö†Ô∏è {{ mensajeError }}
      </p>
    </div>

    <!-- Header con informaci√≥n del carrito -->
    <div style="
      background: rgba(38, 25, 18, 0.8);
      border: 2px solid #8c4520;
      border-radius: 8px;
      padding: clamp(0.8rem, 3vw, 1rem);
      margin-bottom: clamp(1rem, 4vw, 1.5rem);
      text-align: center;
      backdrop-filter: blur(5px);
    ">
      <h1
        class="titulo"
        style="
          color: #ffcc5c;
          font-family: 'Press Start 2P', monospace;
          font-size: clamp(0.8rem, 4vw, 1.2rem);
          text-shadow: 2px 2px 0 #4a260c;
          margin-bottom: clamp(0.5rem, 2vw, 0.8rem);
          line-height: 1.3;
        "
      >
        TIENDA FACE-BOMB
      </h1>

      <!-- Informaci√≥n del carrito -->
      <div *ngIf="itemsCarrito > 0" style="
        display: flex;
        justify-content: center;
        align-items: center;
        gap: clamp(0.5rem, 2vw, 1rem);
        flex-wrap: wrap;
      ">
        <div style="
          background: rgba(255, 176, 0, 0.2);
          border: 1px solid #ffb000;
          border-radius: 6px;
          padding: clamp(0.4rem, 2vw, 0.6rem);
        ">
          <span style="
            color: #ffcc5c;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.4rem, 2vw, 0.5rem);
            text-shadow: 1px 1px 0 #4a260c;
          ">
            üõí {{ itemsCarrito }} ITEM{{ itemsCarrito > 1 ? 'S' : '' }} EN CARRITO
          </span>
        </div>

        <ion-button
          routerLink="/carrito"
          size="small"
          style="
            --background: linear-gradient(90deg, #ffb000 0%, #ff4800 100%);
            --color: #2b1007;
            --border-radius: 6px;
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.4rem, 2vw, 0.5rem);
            min-height: 35px;
            text-shadow: 1px 1px 0 #ffe3b3;
            border: 1px solid #803000;
          "
        >
          VER CARRITO
        </ion-button>
      </div>

      <div *ngIf="itemsCarrito === 0" style="
        color: #f0d1a6;
        font-family: 'Press Start 2P', monospace;
        font-size: clamp(0.4rem, 2vw, 0.5rem);
        text-shadow: 1px 1px 0 #3a1b08;
      ">
        üõí TU CARRITO EST√Å VAC√çO - ¬°AGREGA ALGUNOS PRODUCTOS!
      </div>
    </div>

    <!-- Estado de carga -->
    <div
      *ngIf="cargando"
      style="text-align: center; padding: clamp(2rem, 8vw, 4rem)"
    >
      <div style="
        width: clamp(40px, 10vw, 60px);
        height: clamp(40px, 10vw, 60px);
        border: 3px solid #ffb000;
        border-top: 3px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto clamp(1rem, 3vw, 1.5rem);
      "></div>
      <p
        style="
          color: #ffcc5c;
          font-family: 'Press Start 2P', monospace;
          font-size: clamp(0.6rem, 3vw, 0.8rem);
        "
      >
        CARGANDO PRODUCTOS...
      </p>
    </div>

    <!-- Grid de productos responsive -->
    <div
      *ngIf="!cargando"
      style="
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 300px), 1fr));
        gap: clamp(0.8rem, 3vw, 1rem);
      "
    >
      <ion-card
        *ngFor="let producto of productos"
        style="
          --background: #261912;
          margin: 0;
          border: 3px solid #8c4520;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
          display: flex;
          flex-direction: column;
          height: 100%;
          transition: all 0.3s ease;
        "
      >
        <!-- Imagen del producto -->
        <img
          [src]="producto.imagen"
          (error)="onErrorImagen($event, producto)"
          style="
            width: 100%;
            height: clamp(180px, 35vw, 220px);
            object-fit: cover;
            border-bottom: 2px solid #7b3b1d;
          "
        />

        <ion-card-header
          style="padding: clamp(0.8rem, 3vw, 1rem); flex-shrink: 0"
        >
          <ion-card-title
            style="
              color: #ffcc5c;
              font-family: 'Press Start 2P', monospace;
              font-size: clamp(0.6rem, 3vw, 0.8rem);
              text-shadow: 1px 1px 0 #4a260c;
              margin-bottom: 0.5rem;
              line-height: 1.3;
            "
          >
            {{ producto.nombre || 'Producto' }}
          </ion-card-title>
          <ion-card-subtitle
            style="
              color: #ffb000;
              font-family: 'Press Start 2P', monospace;
              font-size: clamp(0.7rem, 3.5vw, 0.9rem);
              text-shadow: 1px 1px 0 #4a260c;
            "
          >
            üí∞ {{ formatearPrecio(producto.precio) }} monedas
          </ion-card-subtitle>
        </ion-card-header>

        <ion-card-content
          style="
            padding: 0 clamp(0.8rem, 3vw, 1rem) clamp(0.8rem, 3vw, 1rem);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
          "
        >
          <p
            style="
              color: #f0d1a6;
              font-family: 'Press Start 2P', monospace;
              font-size: clamp(0.45rem, 2.2vw, 0.6rem);
              line-height: 1.5;
              margin-bottom: clamp(0.8rem, 3vw, 1rem);
              flex-grow: 1;
            "
          >
            {{ producto.descripcion || 'Descripci√≥n no disponible' }}
          </p>

          <!-- Stock disponible -->
          <div
            *ngIf="producto.stock !== undefined"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: clamp(0.8rem, 3vw, 1rem);
              padding: clamp(0.4rem, 2vw, 0.6rem);
              background: rgba(59, 30, 18, 0.6);
              border-radius: 6px;
              border: 1px solid #7b3b1d;
            "
          >
            <span
              style="
                color: #f0d1a6;
                font-family: 'Press Start 2P', monospace;
                font-size: clamp(0.4rem, 2vw, 0.5rem);
              "
            >
              STOCK:
            </span>
            <span
              [style.color]="producto.stock > 0 ? '#00ff88' : '#ff5555'"
              style="
                font-family: 'Press Start 2P', monospace;
                font-size: clamp(0.4rem, 2vw, 0.5rem);
                text-shadow: 1px 1px 0 #3a1b08;
              "
            >
              {{ producto.stock > 0 ? producto.stock + ' DISPONIBLES' : 'AGOTADO' }}
            </span>
          </div>

          <ion-button
            expand="block"
            class="btn-jugar"
            (click)="agregar(producto.id)"
            [disabled]="producto.stock === 0"
            style="
              --background: linear-gradient(90deg, #ffb000 0%, #ff4800 100%);
              --color: #2b1007;
              --border-radius: 8px;
              border: 2px solid #803000;
              font-family: 'Press Start 2P', monospace;
              font-size: clamp(0.5rem, 2.5vw, 0.6rem);
              min-height: 44px;
              margin: 0;
              text-shadow: 1px 1px 0 #ffe3b3;
            "
          >
            {{ producto.stock === 0 ? 'AGOTADO' : 'üõí AGREGAR AL CARRITO' }}
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Mensaje si no hay productos -->
    <div
      *ngIf="!cargando && productos.length === 0"
      style="
        text-align: center;
        padding: clamp(2rem, 8vw, 4rem);
        color: #f0d1a6;
      "
    >
      <ion-icon
        name="alert-circle-outline"
        style="
          font-size: clamp(3rem, 12vw, 5rem);
          color: #ffb000;
          margin-bottom: clamp(1rem, 4vw, 1.5rem);
        "
      ></ion-icon>
      <p
        style="
          font-family: 'Press Start 2P', monospace;
          font-size: clamp(0.6rem, 3vw, 0.8rem);
          line-height: 1.4;
        "
      >
        No hay productos disponibles en este momento.
      </p>
    </div>
  </div>
</ion-content>

<style>
@keyframes pulse {
  0% {
    transform: scale(1);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
  }
  50% {
    transform: scale(1.1);
    box-shadow: 0 3px 8px rgba(255, 72, 0, 0.7);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
  }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Mejoras para dispositivos peque√±os */
@media (max-width: 320px) {
  .container {
    padding: 0.5rem !important;
  }
}
</style>
